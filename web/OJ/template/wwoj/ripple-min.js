/**
 * Water ripple effect.
 * Original code (Java) by Neil Wallis
 * Code snipplet adapted to Javascript by Sergey Chikuyonok
 * Code re-written as jQuery plugin by Andrei Varabyou
 */
(function(e,t,n,r){function o(t,n){this.element=t;this.options=e.extend({},s,n);this._defaults=s;this._name=i;if(t.tagName=="IMG"){var r=e(this.element).attr("src")}else{var o=e(this.element).css("background-image");if(o!="none"){var u=/url\(['"]?(.+)['"]?\)/;var r=u.exec(o)[1]}}if(typeof r!=="undefined"){var a=this;this.image=e("<img/>").attr("crossOrigin","anonymous").attr("src",r).load(function(){a.init()})}}function u(){f(this);this.ctx.putImageData(this.ripple,0,0)}function a(e,t){e<<=0;t<<=0;for(var n=t-this.riprad;n<t+this.riprad;n++){for(var r=e-this.riprad;r<e+this.riprad;r++){this.ripplemap[this.oldind+n*this.width+r]+=512}}}function f(e){var t,n,r,i,s,o,u;t=e.oldind;e.oldind=e.newind;e.newind=t;t=0;e.mapind=e.oldind;var a=e.width,f=e.height,l=e.ripplemap,c=e.mapind,h=e.newind,p=e.last_map,d=e.ripple.data,v=e.texture.data,m=e.half_width,g=e.half_height;for(var y=0;y<f;y++){for(var b=0;b<a;b++){i=l[c-a]+l[c+a]+l[c-1]+l[c+1]>>1;i-=l[h+t];i-=i>>5;l[h+t]=i;i=1024-i;u=p[t];p[t]=i;if(u!=i){n=((b-m)*i/1024<<0)+m;r=((y-g)*i/1024<<0)+g;if(n>=a)n=a-1;if(n<0)n=0;if(r>=f)r=f-1;if(r<0)r=0;o=(n+r*a)*4;s=t*4;d[s]=v[o];d[s+1]=v[o+1];d[s+2]=v[o+2]}++c;++t}}e.mapind=c}var i="waterripple",s={delay:30,riprad:3,line_width:20,arbitrary:1e3,onclick:false,onmove:false};o.prototype={init:function(){var t={};t.canvas=n.createElement("canvas");e(this.element).after(t.canvas);t.ctx=t.canvas.getContext("2d");t.width=e(this.element).width();t.height=e(this.element).height();t.delay=this.options.delay;t.riprad=this.options.riprad;t.line_width=this.options.line_width;t.half_width=t.width>>1;t.half_height=t.height>>1;t.size=t.width*(t.height+2)*2;t.oldind=t.width;t.newind=t.width*(t.height+3);t.mapind;t.ripplemap=[];t.last_map=[];t.step=t.line_width*2;t.count=t.height/t.line_width;t.canvas.width=t.width;t.canvas.height=t.height;t.ctx.drawImage(this.image[0],0,0);e(this.element).hide();t.texture=t.ctx.getImageData(0,0,t.width,t.height);t.ripple=t.ctx.getImageData(0,0,t.width,t.height);for(var r=0;r<t.size;r++){t.last_map[r]=t.ripplemap[r]=0}setInterval(function(){u.call(t)},t.delay);if(this.options.arbitrary>0){var i=Math.random;a.call(t,i()*t.width,i()*t.height);setInterval(function(){a.call(t,i()*t.width,i()*t.height)},this.options.arbitrary)}if(this.options.onclick){t.canvas.onclick=function(e){a.call(t,e.offsetX||e.layerX,e.offsetY||e.layerY)}}if(this.options.onmove){t.canvas.onmousemove=function(e){a.call(t,e.offsetX||e.layerX,e.offsetY||e.layerY)}}}};e.fn[i]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new o(this,t))}})}})(jQuery,window,document)